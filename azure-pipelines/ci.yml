trigger:
  branches:
    include:
      - main

pr: none

pool:
  vmImage: "ubuntu-latest"

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "22"
    displayName: "Use Node.js 22"

  - script: npm ci
    displayName: "Install dependencies"

  - script: npm run build
    displayName: "Build & Typecheck"

  - script: npm audit --audit-level=high
    displayName: "Security audit"

  - script: npm pack --dry-run
    displayName: "Preview package contents"

  - script: npm pack
    displayName: "Create npm tarball"

  - task: CopyFiles@2
    displayName: "Copy tarball to staging"
    inputs:
      sourceFolder: $(Build.SourcesDirectory)
      contents: "*.tgz"
      targetFolder: $(Build.ArtifactStagingDirectory)

  - task: PublishBuildArtifacts@1
    displayName: "Publish artifacts"
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)"
      ArtifactName: "drop"
      publishLocation: "Container"
