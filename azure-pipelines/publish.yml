trigger: none
pr: none

parameters:
  - name: version
    displayName: "Version bump type"
    type: string
    default: patch
    values:
      - patch
      - minor
      - major

  - name: dryRun
    displayName: "Dry run (skip actual publish)"
    type: boolean
    default: false

pool:
  vmImage: "ubuntu-latest"

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "22"
    displayName: "Use Node.js 22"

  - script: npm ci
    displayName: "Install dependencies"

  - script: npm run build
    displayName: "Build"

  - script: |
      git config user.name "Azure Pipelines"
      git config user.email "azuredevops@pexcard.com"
      npm version ${{ parameters.version }} -m "chore: release v%s"
    displayName: "Bump version"

  - script: npm publish --access public
    displayName: "Publish to NPM"
    condition: eq('${{ parameters.dryRun }}', false)
    env:
      NODE_AUTH_TOKEN: $(NPM_TOKEN)

  - script: npm publish --dry-run
    displayName: "Publish dry run"
    condition: eq('${{ parameters.dryRun }}', true)
    env:
      NODE_AUTH_TOKEN: $(NPM_TOKEN)

  - script: git push --follow-tags
    displayName: "Push version commit and tag"
    condition: eq('${{ parameters.dryRun }}', false)
